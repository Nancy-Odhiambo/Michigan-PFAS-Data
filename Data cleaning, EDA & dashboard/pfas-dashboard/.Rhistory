# and cleaning variable names
public_water_wide <- public_water |>
left_join(public_water_shape, by = "HexID") |>
dplyr::select(-ends_with(c("Result", "Flags"))) |>
clean_names() |>
dplyr::rename(object_id = objectid) |>
dplyr::select(object_id:sys_loc_code, longitude, latitude, everything()) |>
bind_cols(dplyr::select(public_water, ends_with("Result"))) |>
add_geoid()
# Pivoting public water data from wide to long format
public_water_long <- public_water_wide |>
pivot_longer(cols = c(ends_with(c("Result"))),
names_to = "analyte",
values_to = "analyte_value") |>
mutate(analyte = gsub(analyte, pattern = "Result", replacement = "")) |>
dplyr::select(-c(hex_id,
wssn, loc_name:sys_loc_code,
phase_code:task_type,
treatment_status:sys_sample_code,
lab_number:lab_sdg,
object_id, position_source,
analytical_method,
sampling_results_count)) |>
mutate(system_type = fct_recode(system_type,
"Non-Community Water Supply (Adult Foster Care Provider)" = "ADFSTC",
"Non-Community Water Supply (Children's Camp)" = "CHLCMP",
"Non-Community Water Supply (Child Care Provider)" = "DAYCARE",
"Non-Community Water Supply (Industry)" = "INDUS",
"Non-Community Water Supply (Medical Care Provider)" = "MEDCAR",
"Non-Community Water Supply (Hotel or Motel)" = "MOTEL",
"Community Water Supply (for example Municipal Supply, Apartment, Nursing Home, Prison, etc.)" = "MUN",
"Office Building" = "OFFICE",
"Park" = "PARK",
"Residential" = "RESD",
"School" = "SCH",
"Tribal Lands" = "TRB"))
# Saving to external CSV
write_csv(public_water_long, file = "pfas_public_water_long.csv")
#| eval: true
#| include: false
pfas_site_path <- "pfas_sites.csv"
if(file.exists(pfas_site_path) == FALSE) {
# Importing data on identified sites from https://www.michigan.gov/pfasresponse
# Downloaded on 02/25/2025
pfas_sites <- read_csv("Michigan_PFAS_Sites.csv") |>
janitor::clean_names() |>
dplyr::select(facility:site_type, location:military, facility_date, site_background:anticipated_activities, -tier, -site_type) |>
add_geoid()
# Saving cleaned data
write_csv(pfas_sites, file = pfas_site_path)
} else {
# Importing
pfas_sites <- read_csv(pfas_site_path)
}
# Drop flag columns, replace NA in PFAS Result columns with 0, and ensure numeric
public_water_wide <- public_water_wide |>
select(-ends_with("Flags")) |>
mutate(across(ends_with("Result"), ~replace_na(as.numeric(.x), 0)))
# Calculating the hazard index
public_water_wide <- public_water_wide |>
mutate(Hazard_Index = (HFPODAResult / 10) +
(PFNAResult / 10) +
(PFBSResult / 2000) +
(PFHxSResult / 10))
# Displaying the high index areas with the highest analyte contributor in a table
high_hazard <- public_water_wide |>
filter(Hazard_Index > 1) |>
select(hex_id, sample_date, Hazard_Index, HFPODAResult, PFNAResult, PFBSResult, PFHxSResult) |>
arrange(desc(Hazard_Index)) |>
flextable() |>
set_caption("Public Water Locations with Hazard Index > 1") |>
autofit()
# Extracting the maximum hazard per hex ID
public_water_max <- public_water_wide |>
group_by(hex_id) |>
slice_max(order_by = Hazard_Index, n = 1, with_ties = FALSE) |>
ungroup()
# Changing the wide format to long format
public_water_max_long <- public_water_max |>
pivot_longer(cols = ends_with("Result"),
names_to = "analyte",
values_to = "analyte_value") |>
mutate(analyte = gsub("Result$", "", analyte))
merged_data <- public_water_max_long |>
left_join(
pfas_sites |> mutate(geoid = as.character(geoid)),
by = "geoid",
relationship = "many-to-many"
)
# Reusable JS for auto-hover
js_auto_hover <- "
function(el, x) {
var totalPoints = el.data[0].x.length;
var i = 0;
setInterval(function() {
Plotly.Fx.hover(el, [{ curveNumber: 0, pointNumber: i }]);
i = (i + 1) % totalPoints;
}, 2000);
}
"
# Reusable JS for auto-hover on pie charts
js_auto_hover_pie <- "
function(el, x) {
var totalSlices = el.data[0].labels.length; // number of pie slices
var i = 0;
setInterval(function() {
Plotly.Fx.hover(el, [{ curveNumber: 0, pointNumber: i }]);
i = (i + 1) % totalSlices;
}, 2000);
}
"
# Prepare system type mapping
system_type_map <- tibble(
short_name = c(
"ADFSTC", "CHLCMP", "DAYCARE", "INDUS", "MEDCAR",
"MOTEL", "MUN", "OFFICE", "PARK", "RESD", "SCH", "TRB"
),
full_name = c(
"Non-Community Water Supply (Adult Foster Care Provider)",
"Non-Community Water Supply (Children's Camp)",
"Non-Community Water Supply (Child Care Provider)",
"Non-Community Water Supply (Industry)",
"Non-Community Water Supply (Medical Care Provider)",
"Non-Community Water Supply (Hotel or Motel)",
"Community Water Supply (for example Municipal Supply, Apartment, Nursing Home, Prison, etc.)",
"Office Building",
"Park",
"Residential",
"School",
"Tribal Lands"
)
)
# Apply short names to the dataset
public_water_max_long <- public_water_max_long |>
mutate(system_short = recode(system_type,
"Non-Community Water Supply (Adult Foster Care Provider)" = "ADFSTC",
"Non-Community Water Supply (Children's Camp)" = "CHLCMP",
"Non-Community Water Supply (Child Care Provider)" = "DAYCARE",
"Non-Community Water Supply (Industry)" = "INDUS",
"Non-Community Water Supply (Medical Care Provider)" = "MEDCAR",
"Non-Community Water Supply (Hotel or Motel)" = "MOTEL",
"Community Water Supply (for example Municipal Supply, Apartment, Nursing Home, Prison, etc.)" = "MUN",
"Office Building" = "OFFICE",
"Park" = "PARK",
"Residential" = "RESD",
"School" = "SCH",
"Tribal Lands" = "TRB"
))
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate analyte-level hazard contributions across all hexes
total_analyte_hazard <- public_water_max_long |>
filter(analyte %in% hazard_analytes) |>
mutate(analyte_hazard = case_when(
analyte == "HFPODA" ~ analyte_value / 10,
analyte == "PFNA"   ~ analyte_value / 10,
analyte == "PFBS"   ~ analyte_value / 2000,
analyte == "PFHxS"  ~ analyte_value / 10
)) |>
group_by(analyte) |>
summarise(
total_contribution = sum(analyte_hazard, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(total_contribution)) |>
mutate(
percent = round(total_contribution / sum(total_contribution) * 100, 1),
analyte = factor(analyte, levels = analyte)
)
# JS for automatic hover (consistent with your other plots)
js_auto_hover <- "
function(el, x) {
var totalBars = el.data[0].x.length;
var i = 0;
setInterval(function() {
Plotly.Fx.hover(el, [{ curveNumber: 0, pointNumber: i }], 'xy');
i = (i + 1) % totalBars;
}, 2000);
}
"
# Extend y-axis to prevent clipped text
y_max <- max(total_analyte_hazard$total_contribution, na.rm = TRUE) * 1.15
# Create Plotly bar chart with cividis palette
p_bar <- plot_ly(
data = total_analyte_hazard,
x = ~analyte,
y = ~total_contribution,
type = "bar",
color = ~analyte,
colors = viridis::viridis(
n = length(unique(total_analyte_hazard$analyte)),
option = "cividis"
),
text = ~paste0(percent, "%"),
textposition = "outside",
hoverinfo = "text",
hovertext = ~paste(
"<b>Analyte:</b>", analyte,
"<br><b>Total Contribution:</b>", round(total_contribution, 2),
"<br><b>Percent of Total:</b>", percent, "%"
)
) |>
layout(
title = "Total Decomposed Hazard Index Contributions by Analyte",
xaxis = list(title = "Analyte"),
yaxis = list(
title = "Total Hazard Index Contribution",
range = c(0, y_max)
),
showlegend = FALSE,
margin = list(t = 80),
hoverlabel = list(
bgcolor = "lightyellow",
font = list(color = "black", size = 12),
bordercolor = "orange"
)
) |>
onRender(js_auto_hover)
p_bar
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Color palette
max_radius <- 20
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend values (just 3 representative bubbles)
legend_values <- c(0.25, 0.5, 1)  # fraction of max for size
legend_radius <- sqrt(legend_values) * max_radius
legend_colors <- hazard_pal(legend_values * max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
# Build custom HTML legend (color + size only, horizontal layout)
legend_html <- paste0(
"<div style='line-height:1.5;background:white;padding:10px;border-radius:5px;
box-shadow:0 0 5px rgba(0,0,0,0.3);width:auto;'>",
"<h4 style='margin:0;color:#4B0082;'>Hazard Index</h4>",
"<div style='display:flex;align-items:center;justify-content:space-around;'>",
paste0(
sapply(seq_along(legend_values), function(i) {
paste0(
"<svg height='", max(legend_radius)*2, "' width='", max(legend_radius)*2, "' style='margin-right:5px;'>",
"<circle cx='", max(legend_radius), "' cy='", max(legend_radius),
"' r='", legend_radius[i], "' fill='", legend_colors[i],
"' fill-opacity='0.7' stroke='black' stroke-width='0.5'/>",
"</svg>"
)
}),
collapse = ""
),
"</div>",
"</div>"
)
# Get bounding box of Michigan counties
mi_bounds <- st_bbox(mi_counties)
# Build interactive Leaflet map with custom zoom and bubble legend
leaflet(hazard_sites_full) %>%
# Center on Michigan with zoomed-out view so full state fits
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
# Base map tiles
addProviderTiles(providers$CartoDB.Positron) %>%
# Michigan county polygons
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
# Hazard site markers
addCircleMarkers(
radius = ~scaled_radius,  # proportional to Hazard_Index
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
# Custom HTML bubble legend (color + size only)
addControl(html = legend_html, position = "topright")
#| label: hazard_bubble_map
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26") %>%
st_transform(4326)
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites (sf)
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
mutate(system_name = str_to_title(str_remove(system_name, pattern = "[,] City Of"))) |>
replace_na(list(system_name = "Unknown",
type = "Unknown")) |>
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(
Hazard_Index = as.numeric(Hazard_Index),
popup_label = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", sprintf("%.1f", Hazard_Index)
)
)
# Color palette + scaled radius
max_radius <- 20
desired_max <- 35
# Update scaled_radius calculation to use desired_max
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / desired_max) * max_radius)
# Create legend data with extended range and scaled radius
legend_data <- tibble(
Hazard_Index = seq(5, desired_max, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / desired_max) * max_radius)
hazard_pal <- colorNumeric(
palette = c("#e5f5f9", "#99d8c9", "#2ca25f", "#006d2c"),
domain = c(0, desired_max)
)
# Build searchable field
hazard_sites_full <- hazard_sites_full %>%
mutate(search_field = system_name)
# SharedData for Crosstalk
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# LEAFLET MAP
map_widget <- hazard_sites_full %>%
leaflet() %>%
setView(lng = -84.5, lat = 44.5, zoom = 5.5) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3
) %>%
addCircleMarkers(
lng = ~st_coordinates(geometry)[,1],
lat = ~st_coordinates(geometry)[,2],
radius = ~scaled_radius,
color = ~hazard_pal(Hazard_Index),
fillColor = ~hazard_pal(Hazard_Index),
fillOpacity = 0.7,
opacity = 1,
weight = 1,
popup = ~popup_label,
label = ~lapply(popup_label, htmltools::HTML)
) |>
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = 'Hazard Index',
baseSize = max_radius / sqrt(desired_max / desired_max),  # Scaling factor
shape = 'circle',
orientation = 'vertical',
opacity = 1,
fillOpacity = 0.7,
position = 'bottomright',
breaks = legend_data$Hazard_Index
)
map_widget
# JS for automatic bar hover
js_auto_hover <- "
function(el, x) {
var totalPoints = el.data[0].y.length;
var i = 0;
setInterval(function() {
Plotly.Fx.hover(el, [{ curveNumber: 0, pointNumber: i }], 'xy');
i = (i + 1) % totalPoints;
}, 2000);
}
"
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate analyte-level hazard contributions per county
county_analytes <- public_water_max_long %>%
filter(
Hazard_Index > 1,
analyte %in% hazard_analytes,
!is.na(analyte_value)
) %>%
mutate(
analyte_hazard = case_when(
analyte == "HFPODA" ~ analyte_value / 10,
analyte == "PFNA"   ~ analyte_value / 10,
analyte == "PFBS"   ~ analyte_value / 2000,
analyte == "PFHxS"  ~ analyte_value / 10
)
) %>%
group_by(geoid, analyte) %>%
summarise(
total_hazard_analyte = sum(analyte_hazard, na.rm = TRUE),
n_sites = n_distinct(system_name),
.groups = "drop"
)
# Join county names and remove unknown counties
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
st_drop_geometry() %>%
select(GEOID, NAME)
county_analytes <- county_analytes %>%
left_join(county_info, by = c("geoid" = "GEOID")) %>%
filter(!is.na(NAME))
# Compute total hazard per county to get top 15
county_total <- county_analytes %>%
group_by(NAME) %>%
summarise(
total_hazard = sum(total_hazard_analyte, na.rm = TRUE),
.groups = "drop"
) %>%
arrange(desc(total_hazard)) %>%
slice_head(n = 15)
# Identify dominant analyte per county for tooltip
dominant_per_county <- county_analytes %>%
filter(NAME %in% county_total$NAME) %>%
group_by(NAME) %>%
slice_max(total_hazard_analyte, n = 1, with_ties = FALSE) %>%
ungroup() %>%
select(NAME, dominant_analyte = analyte, dominant_hazard = total_hazard_analyte)
# Prepare plot data: top 15 counties only, ordered by total hazard
plot_data <- county_analytes %>%
filter(NAME %in% county_total$NAME) %>%
left_join(dominant_per_county, by = "NAME") %>%
left_join(county_total, by = "NAME") %>%
arrange(desc(total_hazard)) %>%
mutate(NAME = factor(NAME, levels = unique(NAME)))  # enforce descending order
# Create Plotly stacked bar chart
p_overall <- plot_ly(
data = plot_data,
x = ~NAME,
y = ~total_hazard_analyte,
type = "bar",
color = ~analyte,
colors = viridis::cividis(length(hazard_analytes), end = 0.9),
hoverinfo = "text",
text = ~round(total_hazard_analyte, 2),
textposition = "inside",
hovertext = ~paste0(
"<b>County:</b> ", NAME,
"<br><b>Total Hazard Index:</b> ", round(total_hazard, 2),
"<br><b>Dominant Analyte:</b> ", dominant_analyte,
"<br><b>Contribution of Dominant Analyte:</b> ", round(dominant_hazard, 2),
"<br><b>Number of Sites:</b> ", n_sites
)
) %>%
layout(
title = "Top 15 Counties with Hazard Index >1",
barmode = "stack",
xaxis = list(title = "County", tickangle = -45),
yaxis = list(title = "Hazard Index"),
margin = list(b = 150),
hoverlabel = list(
bgcolor = "lightyellow",
font = list(size = 12, color = "black"),
bordercolor = "orange"
)
) %>%
onRender(js_auto_hover)
p_overall

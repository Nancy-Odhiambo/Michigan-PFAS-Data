# Center on Michigan with zoomed-out view so full state fits
setView(lng = -84.5, lat = 44.5, zoom = 6.5) %>%
# Base map tiles
addProviderTiles(providers$CartoDB.Positron) %>%
# Michigan county polygons
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
# Hazard site markers
addCircleMarkers(
radius = ~scaled_radius,  # proportional to Hazard_Index
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
# Custom HTML bubble legend (color + size only)
addControl(html = legend_html, position = "topright")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long |>
filter(analyte %in% hazard_analytes) |>
select(hex_id, analyte, analyte_value) |>
pivot_wider(names_from = analyte, values_from = analyte_value, values_fill = 0)
# Prepare hazard sites with all relevant columns
hazard_sites_full <- public_water_max_long |>
filter(Hazard_Index > 1) |>
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) |>
rename(type = system_type) |>
left_join(analyte_wide, by = "hex_id") |>
st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
# Define color palette for Hazard_Index (reverse for descending legend)
hazard_pal <- colorNumeric(
palette = "magma",
domain = hazard_sites_full$Hazard_Index,
reverse = TRUE   # ensures legend shows high → low
)
# Create popup labels
hazard_popup <- hazard_sites_full |>
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Build interactive Leaflet map
leaflet(hazard_sites_full) |>
setView(lng = -84.5, lat = 44.5, zoom = 7) |>
addProviderTiles(providers$CartoDB.Positron) |>
# Hazard site markers with clustering
addCircleMarkers(
radius = ~sqrt(Hazard_Index) * 3,
fillColor = ~hazard_pal(Hazard_Index),
color = NA,
fillOpacity = 0.7,
stroke = FALSE,
label = lapply(hazard_popup$popup, HTML),
clusterOptions = markerClusterOptions()
) |>
# Custom HTML gradient legend (descending order)
addControl(
html = paste0(
"<div style='background:white;padding:10px;border-radius:6px;
box-shadow:0 1px 6px rgba(0,0,0,0.2); font-size:12px;'>
<div style='font-weight:bold;margin-bottom:4px;'>Hazard Index (High → Low)</div>
<div style='background:linear-gradient(to right, #fcfdbf, #fe9f6d, #de4968, #8c2981, #3b0f6f, #000004);
height:15px; border:1px solid #999; margin-bottom:4px;'></div>
<div style='display:flex; justify-content:space-between;'>
<span>", round(max(hazard_sites_full$Hazard_Index, na.rm = TRUE), 2), "</span>
<span>", round(min(hazard_sites_full$Hazard_Index, na.rm = TRUE), 2), "</span>
</div>
</div>"
),
position = "bottomright"
)
# Aggregate Hazard Index by county
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate hazard index contributions by county and analyte
county_analytes <- public_water_max_long |>
filter(Hazard_Index > 1, !is.na(analyte), analyte %in% hazard_analytes) |>
distinct(hex_id, geoid, analyte, Hazard_Index) |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Compute total hazard per county
county_total <- county_analytes |>
group_by(geoid) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop")
# Compute dominant analyte per county
county_dominant <- county_analytes |>
group_by(geoid) |>
slice_max(order_by = total_hazard_analyte, n = 1, with_ties = FALSE) |>
ungroup() |>
rename(dominant_analyte = analyte, dominant_hazard = total_hazard_analyte)
# Join totals and dominant analyte info
county_hazard <- county_total |>
left_join(county_dominant, by = "geoid") |>
left_join(
st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME, STATEFP),
by = c("geoid" = "GEOID")
) |>
filter(!is.na(NAME)) |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)   # keep top 10 counties
# Create ggplot object with interactive tooltip
p_hazard <- ggplot(county_hazard, aes(
x = reorder(NAME, total_hazard),
y = total_hazard,
fill = total_hazard,
text = paste(
"Total Hazard Index:", round(total_hazard, 2),
"<br>Dominant analyte:", dominant_analyte,
"<br>Hazard Contribution:", round(dominant_hazard, 2)
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_c(option = "viridis") +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Total Hazard Index",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert ggplot to interactive Plotly object with hover text
ggplotly(p_hazard, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate hazard index contributions by county and analyte
county_analytes <- public_water_max_long |>
filter(Hazard_Index > 1, !is.na(analyte), analyte %in% hazard_analytes) |>
distinct(hex_id, geoid, analyte, Hazard_Index) |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Join county names
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME, STATEFP)
county_analytes <- county_analytes |>
left_join(county_info, by = c("geoid" = "GEOID"))
# Compute total hazard per county to filter top 10
county_total <- county_analytes |>
group_by(geoid, NAME) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop") |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter analyte contributions to top 10 counties
county_analytes_top <- county_analytes |>
filter(geoid %in% county_total$geoid)
# Compute dominant analyte for tooltip
county_dominant <- county_analytes_top |>
group_by(geoid) |>
slice_max(order_by = total_hazard_analyte, n = 1, with_ties = FALSE) |>
ungroup() |>
rename(dominant_analyte = analyte, dominant_hazard = total_hazard_analyte)
# Join dominant analyte info for tooltip
county_analytes_top <- county_analytes_top |>
left_join(county_dominant %>% dplyr::select(geoid, dominant_analyte, dominant_hazard), by = "geoid")
# Create ggplot stacked bar chart
p_hazard <- ggplot(county_analytes_top, aes(
x = reorder(NAME, total_hazard),
y = total_hazard_analyte,
fill = analyte,
text = paste(
"County:", NAME,
"<br>Analyte:", analyte,
"<br>Hazard Contribution:", round(total_hazard_analyte, 2),
"<br>Dominant analyte:", dominant_analyte,
"<br>Dominant Hazard:", round(dominant_hazard, 2)
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_d(option = "viridis", end = 0.9) +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Hazard Index by Analyte",
fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert to interactive Plotly chart
ggplotly(p_hazard, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate hazard index contributions by county and analyte
county_analytes <- public_water_max_long |>
filter(Hazard_Index > 1, !is.na(analyte), analyte %in% hazard_analytes) |>
distinct(hex_id, geoid, analyte, Hazard_Index) |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Join county names
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME)
county_analytes <- county_analytes |>
left_join(county_info, by = c("geoid" = "GEOID"))
# Compute total hazard per county to get top 10
county_total <- county_analytes |>
group_by(geoid, NAME) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop") |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter analytes to top 10 counties
county_analytes_top <- county_analytes |>
filter(geoid %in% county_total$geoid)
# Create stacked bar plot
p_hazard <- ggplot(county_analytes_top, aes(
x = reorder(NAME, total_hazard_analyte),  # order can also use total per county if desired
y = total_hazard_analyte,
fill = analyte,
text = paste(
"County:", NAME,
"<br>Analyte:", analyte,
"<br>Hazard Contribution:", round(total_hazard_analyte, 2)
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_d(option = "viridis", end = 0.9) +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Hazard Index by Analyte",
fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert to interactive Plotly chart
ggplotly(p_hazard, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Prepare unique values and keep only hazard analytes
unique_values <- public_water_max_long |>
distinct(hex_id, system_name, analyte, analyte_value) |>
filter(analyte %in% hazard_analytes) |>        # remove non-hazard analytes
mutate(system_name = tolower(system_name))
# Aggregate total analyte value by system name
total_by_system <- unique_values |>
group_by(system_name, analyte) |>
summarise(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop")
# Identify top 10 systems by total hazard
top_systems <- total_by_system |>
group_by(system_name) |>
summarise(total_hazard = sum(total_value, na.rm = TRUE), .groups = "drop") |>
ungroup() |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter for top 10 systems and order factor levels
plot_data <- total_by_system |>
filter(system_name %in% top_systems$system_name) |>
mutate(system_name = factor(system_name, levels = top_systems$system_name))
# Create ggplot object with interactive tooltip (stacked bars)
p_total <- ggplot(plot_data, aes(x = system_name, y = total_value, fill = analyte,
text = paste("System:", system_name,
"<br>Analyte:", analyte,
"<br>Total Value:", round(total_value, 2)))) +
geom_col(width = 0.7, position = "stack") +  # Stacked bar plot
scale_fill_viridis_d(option = "plasma") +    # Color scale
labs(title = "Total PFAS Hazard by Top 10 Systems",
x = "System Name", y = "Total Hazard Value (ppt)", fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)") +
theme_minimal() +
theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
# Convert ggplot to interactive Plotly object
ggplotly(p_total, tooltip = "text")
merged_data <- public_water_max_long |>
left_join(
pfas_sites |> mutate(geoid = as.character(geoid)),
by = "geoid",
relationship = "many-to-many"
)
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Merge data (many-to-many)
merged_data <- public_water_max_long |>
left_join(
pfas_sites |> mutate(geoid = as.character(geoid)),
by = "geoid",
relationship = "many-to-many"
)
# Keep only hazard analytes and Hazard_Index > 1
merged_hazard <- merged_data |>
filter(analyte %in% hazard_analytes, Hazard_Index > 1) |>
distinct(hex_id, geoid, system_name, analyte, Hazard_Index)
# Aggregate total hazard per county and analyte
county_analytes <- merged_hazard |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Count number of sites per county
county_sites <- merged_hazard |>
group_by(geoid) |>
summarise(num_sites = n_distinct(hex_id), .groups = "drop")
# Identify dominant analyte per county
county_dominant <- county_analytes |>
group_by(geoid) |>
slice_max(order_by = total_hazard_analyte, n = 1, with_ties = FALSE) |>
ungroup() |>
rename(high_analyte = analyte, high_hazard = total_hazard_analyte)
# Join county info, site count, and dominant analyte
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME)
county_analytes <- county_analytes |>
left_join(county_sites, by = "geoid") |>
left_join(county_dominant %>% select(geoid, high_analyte, high_hazard), by = "geoid") |>
left_join(county_info, by = c("geoid" = "GEOID"))
# Compute total hazard per county to get top 10
county_total <- county_analytes |>
group_by(geoid, NAME, num_sites, high_analyte, high_hazard) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop") |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter analytes to top 10 counties
county_analytes_top <- county_analytes |>
filter(geoid %in% county_total$geoid)
# Create stacked bar plot with modified tooltip
p_hazard <- ggplot(county_analytes_top, aes(
x = reorder(NAME, total_hazard_analyte),
y = total_hazard_analyte,
fill = analyte,
text = paste(
"Hazard Contribution:", round(total_hazard_analyte, 2),
"<br>Number of Sites:", num_sites,
"<br>High Analyte:", high_analyte
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_d(option = "viridis", end = 0.9) +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Hazard Index by Analyte",
fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert to interactive Plotly chart
ggplotly(p_hazard, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Prepare unique values and keep only hazard analytes
unique_values <- public_water_max_long |>
distinct(hex_id, system_name, analyte, analyte_value) |>
filter(analyte %in% hazard_analytes) |>        # remove non-hazard analytes
mutate(system_name = tolower(system_name))
# Aggregate total analyte value by system name
total_by_system <- unique_values |>
group_by(system_name, analyte) |>
summarise(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop")
# Identify top 10 systems by total hazard
top_systems <- total_by_system |>
group_by(system_name) |>
summarise(total_hazard = sum(total_value, na.rm = TRUE), .groups = "drop") |>
ungroup() |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter for top 10 systems and order factor levels
plot_data <- total_by_system |>
filter(system_name %in% top_systems$system_name) |>
mutate(system_name = factor(system_name, levels = top_systems$system_name))
# Create ggplot object with interactive tooltip (stacked bars)
p_total <- ggplot(plot_data, aes(x = system_name, y = total_value, fill = analyte,
text = paste("System:", system_name,
"<br>Analyte:", analyte,
"<br>Total Value:", round(total_value, 2)))) +
geom_col(width = 0.7, position = "stack") +  # Stacked bar plot
scale_fill_viridis_d(option = "plasma") +    # Color scale
labs(title = "Total PFAS Hazard by Top 10 Systems",
x = "System Name", y = "Total Hazard Value (ppt)", fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)") +
theme_minimal() +
theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
# Convert ggplot to interactive Plotly object
ggplotly(p_total, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Merge data (many-to-many)
merged_data <- public_water_max_long |>
left_join(
pfas_sites |> mutate(geoid = as.character(geoid)),
by = "geoid",
relationship = "many-to-many"
)
# Keep only hazard analytes and Hazard_Index > 1
merged_hazard <- merged_data |>
filter(analyte %in% hazard_analytes, Hazard_Index > 1) |>
distinct(hex_id, geoid, system_name, analyte, Hazard_Index)
# Aggregate total hazard per county and analyte
county_analytes <- merged_hazard |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Count number of sites per county
county_sites <- merged_hazard |>
group_by(geoid) |>
summarise(num_sites = n_distinct(hex_id), .groups = "drop")
# Identify dominant analyte per county
county_dominant <- county_analytes |>
group_by(geoid) |>
slice_max(order_by = total_hazard_analyte, n = 1, with_ties = FALSE) |>
ungroup() |>
rename(high_analyte = analyte, high_hazard = total_hazard_analyte)
# Join county info, site count, and dominant analyte
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME)
county_analytes <- county_analytes |>
left_join(county_sites, by = "geoid") |>
left_join(county_dominant %>% select(geoid, high_analyte, high_hazard), by = "geoid") |>
left_join(county_info, by = c("geoid" = "GEOID"))
# Compute total hazard per county to get top 10
county_total <- county_analytes |>
group_by(geoid, NAME, num_sites, high_analyte, high_hazard) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop") |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter analytes to top 10 counties
county_analytes_top <- county_analytes |>
filter(geoid %in% county_total$geoid)
# Create stacked bar plot with modified tooltip
p_hazard <- ggplot(county_analytes_top, aes(
x = reorder(NAME, total_hazard_analyte),
y = total_hazard_analyte,
fill = analyte,
text = paste(
"Hazard Contribution:", round(total_hazard_analyte, 2),
"<br>Number of Sites:", num_sites,
"<br>High Analyte:", high_analyte
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_d(option = "viridis", end = 0.9) +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Hazard Index by Analyte",
fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert to interactive Plotly chart
ggplotly(p_hazard, tooltip = "text")
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Aggregate hazard index contributions by county and analyte
county_analytes <- public_water_max_long |>
filter(Hazard_Index > 1, !is.na(analyte), analyte %in% hazard_analytes) |>
distinct(hex_id, geoid, analyte, Hazard_Index) |>
group_by(geoid, analyte) |>
summarise(total_hazard_analyte = sum(Hazard_Index, na.rm = TRUE), .groups = "drop")
# Join county names
county_info <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) |>
st_drop_geometry() |>
dplyr::select(GEOID, NAME)
county_analytes <- county_analytes |>
left_join(county_info, by = c("geoid" = "GEOID"))
# Compute total hazard per county to get top 10
county_total <- county_analytes |>
group_by(geoid, NAME) |>
summarise(total_hazard = sum(total_hazard_analyte, na.rm = TRUE), .groups = "drop") |>
arrange(desc(total_hazard)) |>
slice_head(n = 10)
# Filter analytes to top 10 counties
county_analytes_top <- county_analytes |>
filter(geoid %in% county_total$geoid)
# Create stacked bar plot
p_hazard <- ggplot(county_analytes_top, aes(
x = reorder(NAME, total_hazard_analyte),  # order can also use total per county if desired
y = total_hazard_analyte,
fill = analyte,
text = paste(
"County:", NAME,
"<br>Analyte:", analyte,
"<br>Hazard Contribution:", round(total_hazard_analyte, 2)
)
)) +
geom_col(width = 0.7) +
coord_flip() +
scale_fill_viridis_d(option = "viridis", end = 0.9) +
labs(
title = "Top 10 Counties with Hazard Index > 1",
x = "County",
y = "Hazard Index by Analyte",
fill = "Analyte",
caption = "Data source: Michigan PFAS Action Response Team (MPART)"
) +
theme_minimal()
# Convert to interactive Plotly chart
ggplotly(p_hazard, tooltip = "text")

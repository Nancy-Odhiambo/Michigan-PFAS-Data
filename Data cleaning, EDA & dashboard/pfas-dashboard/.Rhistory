)
ggplotly(p, tooltip = "text") |>
onRender("
function(el) {
var totalPoints = el.data[0].x.length;
var i = 0;
setInterval(function() {
Plotly.Fx.hover(el, [{ curveNumber: 0, pointNumber: i }], 'xy');
i = (i + 1) % totalPoints;
}, 2000);
}
")
# Convert pfas_sites to sf and clean type
pfas_sites_sf <- pfas_sites %>%
mutate(
type = str_replace_all(type, "mlitary", "military"),
type = str_to_title(type),
type = str_replace_all(type, "Laundromat/Drycleaner", "Laundromat/Dry Cleaner"),
type = case_when(
type %in% c("Tannery", "Unknown", "Refinery", "Fire Station") ~ "Other",
TRUE ~ type
),
popup_label = paste0(
"<b>Facility:</b> ", facility, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>County:</b> ", county
)
)
# Crosstalk SharedData
sd_sites <- SharedData$new(pfas_sites_sf, key = ~facility, group = "pfas")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26") %>%
st_transform(4326)
# Viridis palette
pal <- colorFactor("viridis", pfas_sites_sf$type)
# Crosstalk filter UI (placed ABOVE map)
filter_ui <- filter_select(
id = "type_filter",
label = "Search by Site Type",
sharedData = sd_sites,
group = ~type
)
# Leaflet map (full width)
map <- leaflet(sd_sites) %>%
setView(lng = -84.5, lat = 44.5, zoom = 5.5) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3
) %>%
addCircleMarkers(
lng = ~longitude, lat = ~latitude,
radius = 4,
fillColor = ~pal(type),
stroke = FALSE,
fillOpacity = 0.8,
popup = ~popup_label,
label = ~lapply(popup_label, htmltools::HTML)
) %>%
addLegendFactor(
pal = pal,
values = pfas_sites_sf$type,
title = "Contamination Site Type",
position = "topright",
shape = "circle",
width = 8,
height = 8,
fillOpacity = 0.8
)
# Display filter ABOVE map (full width)
tagList(
div(style = "margin-bottom: 10px;", filter_ui),
div(style = "width: 100%;", map)
)
# Visualizing the type of site by the composition of 4 main analytes with the hazard index
# Use the already-cleaned hazard_data_types to get clean type values
# Join back to merged_data to restore analyte columns
hazard_data_analytes <- merged_data |>
inner_join(
hazard_data_types |> select(hex_id, type, Hazard_Index),
by = c("hex_id", "type", "Hazard_Index")
) |>
distinct(hex_id, type, analyte, analyte_value, Hazard_Index) |>
filter(analyte %in% hazard_analytes)
# Summarize total hazard and analyte sums by type
hazard_summary_by_type <- hazard_data_analytes |>
group_by(type, analyte) |>
summarise(sum_analyte = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
left_join(
hazard_data_analytes |>
group_by(type) |>
summarise(
total_hazard = sum(Hazard_Index, na.rm = TRUE),
n_sites = n_distinct(hex_id),
.groups = "drop"
),
by = "type"
) |>
pivot_wider(
names_from = analyte,
values_from = sum_analyte,
values_fill = 0
) |>
mutate(across(where(is.numeric), ~ round(.x, 2))) |>
arrange(desc(total_hazard))
# Assign a unique ID for reactable
tbl_id <- "hazard_summary_table"
# Create the interactive table with custom headers
rt <- reactable(
hazard_summary_by_type,
elementId = tbl_id,
searchable = TRUE,
filterable = TRUE,
showPageSizeOptions = TRUE,
defaultPageSize = 10,
highlight = TRUE,
bordered = TRUE,
striped = TRUE,
columns = list(
type = colDef(name = "TYPE"),
total_hazard = colDef(name = "TOTAL HAZARD"),
n_sites = colDef(name = "N SITES")
)
)
# Create download link-style button in top-right
download_btn <- tags$button(
"Download CSV",
onclick = sprintf("Reactable.downloadDataCSV('%s', 'hazard_summary_by_type.csv')", tbl_id),
style = "
background: none;
border: none;
color: #0073e6;
text-decoration: underline;
cursor: pointer;
font-size: 0.9em;
float: right;
margin-bottom: 5px;
"
)
# Display table with download link above it
browsable(tagList(download_btn, rt))
# Top 10 analyte category by total % & absolute concentration
top10_analyte <- surface_max_full |>
filter(analyte_value > 0) |>
group_by(analyte) |>
summarize(total_concentration = sum(analyte_value, na.rm = TRUE)) |>
ungroup() |>
mutate(share = total_concentration / sum(total_concentration)) |>
slice_max(share, n = 10)
ggplot(top10_analyte, aes(x = fct_reorder(analyte, share),
y = share,
fill = share)) +
geom_col() +
geom_text(aes(
label = paste0(
percent(share, accuracy = 0.1),
" (", comma(round(total_concentration, 1)), "ppt)"
)),
hjust = -0.05, size = 3.2
) +
coord_flip() +
scale_y_continuous(labels = percent_format(accuracy = 1),
expand = expansion(mult = c(0, 0.15))) +
scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) +
scale_fill_viridis_c(option = "cividis", direction = -1) +
labs(title = "Top 10 PFAS Analytes in Surface Water",
x = "Analyte_Category",
y = "PFAS Concentration per Analyte",
fill = "Share",
caption = "Data source: Michigan PFAS Action Response Team (MPART), EGLE") +
theme_minimal() +
theme(plot.title = element_text(face = "bold", size = 15),
axis.title.y = element_text(face = "bold"),
axis.title.x = element_text(face = "bold"),
axis.text.x = element_blank(),   # removes the % tick labels
plot.caption = element_text(face = "bold"),
legend.position = "none")
# Map of total surface water PFAS by county
# Load county shapefile
mi_counties <- suppressMessages(suppressWarnings(st_read("cb_2018_us_county_500k.shp", quiet = TRUE))) |>
filter(STATEFP == "26")
# Aggregate surface water PFAS by county
surface_county_map <- surface_max_full |>
group_by(geoid) |>
summarize(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
left_join(mi_counties, by = c("geoid" = "GEOID")) |>
st_as_sf()
ggplot(surface_county_map) +
geom_sf(aes(fill = total_value), color = "white") +
scale_fill_viridis_c(option = "magma", na.value = "grey90") +
labs(
title = "Total PFAS Concentration in Surface Water by County",
fill = "Total PFAS (ppt)",
caption = "Data source: Michigan PFAS Action Response Team (MPART), EGLE"
) +
theme_minimal()
hazard_colors <- c("HFPODA" = "#575c6d", "PFNA" = "#a69d75", "PFBS" = "#ffea47", "PFHxS" = "#00204d")
# Top 10 PFAS analytes in public water
top_analytes <- public_max_full |>
filter(analyte_value > 0) |>
group_by(analyte) |>
summarize(total_concentration = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
slice_max(total_concentration, n = 10)
other_analytes <- top_analytes$analyte[which(!(top_analytes$analyte %in% names(hazard_colors)))]
other_colors <- setNames(rep("pink", length(other_analytes)), other_analytes)
ggplot(top_analytes, aes(x = fct_reorder(analyte, total_concentration),
y = total_concentration,
fill = analyte)) +
geom_col() +
geom_text(aes(label = comma(round(total_concentration, 1))),
hjust = -0.05, size = 3.5) +  # labels outside bars
coord_flip() +
#  scale_fill_viridis_c(option = "cividis", direction = -1) +
scale_fill_manual(values = c(hazard_colors, other_colors)) +
scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +  # wrap long names
labs(
title = "Top 10 PFAS Analytes in Public Water Systems",
x = "PFAS Analyte",
y = "Total PFAS Concentration (ppt)",
fill = "Total Concentration",
caption = "Data source: Michigan PFAS Action Response Team (MPART), EGLE"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16),
axis.title = element_text(face = "bold"),
legend.position = "none"
) +
expand_limits(y = max(top_analytes$total_concentration) * 1.1)  # space for labels
# Map of total public water PFAS by county
public_county_map <- public_max_full |>
group_by(geoid) |>
summarize(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
left_join(mi_counties, by = c("geoid" = "GEOID")) |>
st_as_sf()
ggplot(public_county_map) +
geom_sf(aes(fill = total_value), color = "white") +
scale_fill_viridis_c(option = "magma", na.value = "grey90") +
labs(
title = "Total PFAS Concentration in Public Water by County",
x = "Longitude",
y = "Latitude",
fill = "Total PFAS (ppt)",
caption = "Data source: Michigan PFAS Action Response Team (MPART), EGLE"
) +
theme_minimal()
library(tidytext)
# Read county shapefile
counties_sf <- suppressMessages(suppressWarnings(st_read("cb_2018_us_county_500k.shp", quiet =TRUE))) |>
st_drop_geometry() |>
select(GEOID, NAME)
# Convert GEOID to character for joining
pfas_sites_conc <- pfas_sites_conc |> mutate(geoid = as.character(geoid))
surface_max_full <- surface_max_full |> mutate(geoid = as.character(geoid))
public_max_full <- public_max_full |> mutate(geoid = as.character(geoid))
# Aggregate total PFAS per county
surface_county_totals <- surface_max_full |>
group_by(geoid) |>
summarize(total_surface = sum(analyte_value, na.rm = TRUE), .groups = "drop")
public_county_totals <- public_max_full |>
group_by(geoid) |>
summarize(total_public = sum(analyte_value, na.rm = TRUE), .groups = "drop")
# Count sites per county
sites_county <- pfas_sites_conc |>
count(geoid) |>
rename(n_sites = n)
# Combine totals by county
county_summary <- surface_county_totals |>
full_join(public_county_totals, by = "geoid") |>
full_join(sites_county, by = "geoid") |>
left_join(counties_sf, by = c("geoid" = "GEOID")) |>
relocate(NAME, .before = geoid) |>
select(NAME, total_surface, total_public, n_sites)
# Flextable for top 10 counties by total_surface
top10_county_table <- county_summary |> slice_max(total_surface, n = 10)
flextable(top10_county_table) |> autofit()
# Pivot longer for faceted bar plot
county_long <- top10_county_table |>
pivot_longer(cols = c(total_surface, total_public, n_sites),
names_to = "metric", values_to = "value") |>
mutate(NAME = reorder_within(NAME, value, metric))  # reorder within facet
# Custom labels for facets
metric_labels <- c(
total_surface = "Total Surface PFAS (ng/L)",
total_public = "Total Public PFAS (ng/L)",
n_sites = "Number of PFAS Sites"
)
# Total PFAS concentration by water type
total_pfas <- bind_rows(
surface_max_full |> summarize(total = sum(analyte_value, na.rm = TRUE)) |> mutate(water_type = "Surface Water"),
public_max_full  |> summarize(total = sum(analyte_value, na.rm = TRUE)) |> mutate(water_type = "Public Water")
) |>
mutate(pct = total / sum(total) * 100,
lbl = paste0(water_type, " (", round(pct, 1), "%)"))
# Pie chart
total_pfas |>
ggplot(aes(x = "", y = total, fill = water_type)) +
geom_col(width = 1, color = "white") +
coord_polar(theta = "y") +
geom_text(aes(label = lbl), position = position_stack(vjust = 0.5), size = 5) +
scale_fill_manual(values = c("Surface Water" = "mediumseagreen", "Public Water" = "tomato")) +
labs(title = "Total PFAS Concentration by Water Type",
caption = "Data source: Michigan PFAS Action Response Team (MPART), EGLE") +
theme_void() +
theme(plot.title = element_text(face = "bold", size = 16),
plot.caption = element_text(face = "bold"))
#| include: false
set.seed(1994)
# Loading necessary packages
library(tidyverse)
library(naniar)
library(janitor)
library(sf)
library(gt)
library(skimr)
library(tidycensus)
library(maps)
library(patchwork)
library(ggrepel)
library(ggthemes)
library(scales)
library(reshape2)
library(ggcorrplot)
library(flextable)
library(dplyr)
library(tidyr)
library(plotly)
library(leaflet)
library(reactable)
library(reactablefmtr)
library(htmltools)
library(leaflet.extras2)
library(leaflegend)
library(htmlwidgets)
library(leaflet.extras)
library(crosstalk)
library(stringr)
library(forcats)
# Function for creating data dictionary
data_dictionary <- function(myData, descripts) {
tibble(Variable = colnames(myData),
Type = map_chr(myData, .f = function(x){typeof(x)[1]}),
Description = descripts) |>
gt()
}
# Top 10 analyte category by total % & absolute concentration
# Prepare data
top10_analyte <- surface_max_full |>
filter(analyte_value > 0) |>
group_by(analyte) |>
summarize(total_concentration = sum(analyte_value, na.rm = TRUE)) |>
ungroup() |>
mutate(share = total_concentration / sum(total_concentration)) |>
slice_max(share, n = 10) |>
arrange(share)
# Interactive Plotly bar chart
p_surface <- plot_ly(
data = top10_analyte,
x = ~share,
y = ~fct_reorder(analyte, share),
type = "bar",
orientation = "h",
marker = list(
color = ~share,
colorscale = "Cividis"
),
text = ~paste0(
percent(share, accuracy = 0.1),
" (", comma(round(total_concentration, 1)), " ppt)"
),
textposition = "outside",
hoverinfo = "text",
hovertext = ~paste(
"<b>Analyte:</b>", analyte,
"<br><b>Share:</b>", percent(share, accuracy = 0.1),
"<br><b>Total Concentration:</b>", comma(round(total_concentration, 1)), "ppt"
)
) |>
layout(
title = "Top 10 PFAS Analytes in Surface Water",
xaxis = list(
title = "Share of Total PFAS",
tickformat = ".0%",
range = c(0, max(top10_analyte$share) * 1.25)
),
yaxis = list(title = "Analyte Category"),
margin = list(l = 120, r = 40, t = 80),
hoverlabel = list(
bgcolor = "lightyellow",
font = list(color = "black", size = 12),
bordercolor = "orange"
),
showlegend = FALSE
) |>
onRender(js_auto_hover)
p_surface
library(leaflet)
library(crosstalk)
library(sf)
library(dplyr)
library(viridis)
# Load Michigan counties
mi_counties <- suppressMessages(
st_read("cb_2018_us_county_500k.shp", quiet = TRUE)
) |>
filter(STATEFP == "26") |>
st_transform(4326)
# Aggregate surface water PFAS by county
surface_county_map <- surface_max_full |>
group_by(geoid) |>
summarize(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
left_join(mi_counties, by = c("geoid" = "GEOID")) |>
st_as_sf()
# SharedData for Crosstalk filtering
shared_surface <- SharedData$new(surface_county_map, key = ~geoid, group = "surface")
# Color palette
pal <- colorNumeric("magma", domain = surface_county_map$total_value)
# Filter widget (dropdown)
filter_widget <- filter_select(
id = "county_filter",
label = "Filter by County",
sharedData = shared_surface,
group = ~NAME
)
# Build interactive map
map_widget <- leaflet(shared_surface) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
fillColor = ~pal(total_value),
fillOpacity = 0.8,
color = "white",
weight = 1,
label = ~paste0(
"<b>", NAME, " County</b><br>",
"Total PFAS: ", round(total_value, 1), " ppt"
) |> lapply(htmltools::HTML),
highlightOptions = highlightOptions(
weight = 2,
color = "black",
fillOpacity = 0.9,
bringToFront = TRUE
)
) %>%
addLegend(
pal = pal,
values = ~total_value,
title = "Total PFAS (ppt)",
position = "bottomright"
)
# Display filter + map together
bscols(
widths = c(4, 8),
filter_widget,
map_widget
)
# Load Michigan counties
mi_counties <- suppressMessages(
st_read("cb_2018_us_county_500k.shp", quiet = TRUE)
) |>
filter(STATEFP == "26") |>
st_transform(4326)
# Aggregate surface water PFAS by county
surface_county_map <- surface_max_full |>
group_by(geoid) |>
summarize(total_value = sum(analyte_value, na.rm = TRUE), .groups = "drop") |>
left_join(mi_counties, by = c("geoid" = "GEOID")) |>
st_as_sf()
# SharedData for Crosstalk filtering
shared_surface <- SharedData$new(surface_county_map, key = ~geoid, group = "surface")
# Color palette
pal <- colorNumeric("magma", domain = surface_county_map$total_value)
# Filter widget (placed above the map)
filter_widget <- filter_select(
id = "county_filter",
label = "Filter by County",
sharedData = shared_surface,
group = ~NAME
)
# Build full-width interactive map
map_widget <- leaflet(shared_surface) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
fillColor = ~pal(total_value),
fillOpacity = 0.8,
color = "white",
weight = 1,
label = ~paste0(
"<b>", NAME, " County</b><br>",
"Total PFAS: ", round(total_value, 1), " ppt"
) |> lapply(htmltools::HTML),
highlightOptions = highlightOptions(
weight = 2,
color = "black",
fillOpacity = 0.9,
bringToFront = TRUE
)
) %>%
addLegend(
pal = pal,
values = ~total_value,
title = "Total PFAS (ppt)",
position = "bottomright"
)
# Display filter above full-width map
htmltools::tagList(
filter_widget,
map_widget
)

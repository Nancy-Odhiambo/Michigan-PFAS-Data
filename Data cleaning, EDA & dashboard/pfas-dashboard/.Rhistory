analyte == "PFBS"   ~ analyte_value / 2000,
analyte == "PFHxS"  ~ analyte_value / 10
)) |>
group_by(analyte) |>
summarise(total_contribution = sum(analyte_hazard, na.rm = TRUE),
.groups = "drop") |>
arrange(desc(total_contribution)) |>
mutate(label = paste0(analyte, " (", round(total_contribution / sum(total_contribution) * 100, 1), "%)"))
# Create pie chart (all slices start un-pulled)
p_pie <- plot_ly(
total_analyte_hazard,
labels = ~label,
values = ~total_contribution,
type = 'pie',
textinfo = 'label',
insidetextorientation = 'radial',
pull = 0,  # initially all slices not pulled
marker = list(line = list(color = '#FFFFFF', width = 1))
) %>%
layout(
title = "Decomposed Hazard Index Contributions by Analyte",
showlegend = FALSE
)
# JS code to pull slices in turns
js_auto_pull <- "
function(el, x) {
var totalSlices = el.data[0].labels.length;
var pulls = Array(totalSlices).fill(0);
var i = 0;
setInterval(function() {
pulls = Array(totalSlices).fill(0);
pulls[i] = 0.15; // pull current slice
Plotly.restyle(el, {'pull': [pulls]});
i = (i + 1) % totalSlices;
}, 2000);
}
"
# Attach JS to pie chart
p_pie <- htmlwidgets::onRender(p_pie, js_auto_pull)
p_pie
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Color palette
max_radius <- 20
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend values
legend_values <- c(0.25, 0.5, 1)
legend_radius <- sqrt(legend_values) * max_radius
legend_colors <- hazard_pal(legend_values * max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
legend_html <- paste0(
"<div style='line-height:1.5;background:white;padding:10px;border-radius:5px;
box-shadow:0 0 5px rgba(0,0,0,0.3);width:auto;'>",
"<h4 style='margin:0;color:#4B0082;'>Hazard Index</h4>",
"<div style='display:flex;align-items:center;justify-content:space-around;'>",
paste0(
sapply(seq_along(legend_values), function(i) {
paste0(
"<svg height='", max(legend_radius)*2, "' width='", max(legend_radius)*2, "' style='margin-right:5px;'>",
"<circle cx='", max(legend_radius), "' cy='", max(legend_radius),
"' r='", legend_radius[i], "' fill='", legend_colors[i],
"' fill-opacity='0.7' stroke='black' stroke-width='0.5'/>",
"</svg>"
)
}),
collapse = ""
),
"</div>",
"</div>"
)
# Build Leaflet map
leaf_map <- leaflet(hazard_sites_full) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
# County polygons
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME,
layerId = ~NAME  # Important for JS
) %>%
# Hazard site markers
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
addControl(html = legend_html, position = "topright")
# JavaScript to auto-hover county polygons
js_auto_hover_county <- "
function(el, x) {
var map = this;
var polygons = [];
// Collect all polygon layers
map.eachLayer(function(layer) {
if(layer instanceof L.Polygon && layer.options.layerId !== undefined) {
polygons.push(layer);
}
});
var i = 0;
setInterval(function() {
// Close all popups first
map.closePopup();
// Open popup for current polygon
polygons[i].bindTooltip(polygons[i].options.layerId, {permanent:true, direction:'auto'}).openTooltip();
i = (i + 1) % polygons.length;
}, 2000); // change every 2 seconds
}
"
# Attach JS auto-hover to map
leaf_map <- htmlwidgets::onRender(leaf_map, js_auto_hover_county)
leaf_map
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites (only those with Hazard_Index > 1)
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Identify counties that have hazard sites
counties_with_hazard <- mi_counties %>%
filter(NAME %in% unique(hazard_sites_full$system_name)) %>%
mutate(layerId = NAME) # assign layerId for JS
# Color palette for hazard bubbles
max_radius <- 20
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups for hazard sites
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Build Leaflet map
leaf_map <- leaflet(hazard_sites_full) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
# Add only counties with hazard sites
addPolygons(
data = counties_with_hazard,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME,
layerId = ~layerId
) %>%
# Hazard site markers
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
)
# JavaScript to auto-hover counties with hazard sites
js_auto_hover_hazard <- "
function(el, x) {
var map = this;
var polygons = [];
// Only include polygons that have layerId (i.e., counties with hazard sites)
map.eachLayer(function(layer) {
if(layer instanceof L.Polygon && layer.options.layerId !== undefined) {
polygons.push(layer);
}
});
var i = 0;
setInterval(function() {
// Reset all polygon labels
polygons.forEach(function(p) {
p.closeTooltip();
});
// Show tooltip for the current polygon
polygons[i].bindTooltip(polygons[i].options.layerId, {permanent:true, direction:'auto'}).openTooltip();
i = (i + 1) % polygons.length;
}, 2000); // cycle every 2 seconds
}
"
# Attach JS auto-hover
leaf_map <- htmlwidgets::onRender(leaf_map, js_auto_hover_hazard)
leaf_map
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites (only those with Hazard_Index > 1)
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Color palette for hazard bubbles
max_radius <- 20
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups for hazard sites
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Identify counties with hazard sites
counties_with_hazard <- mi_counties %>%
filter(NAME %in% unique(hazard_sites_full$system_name)) %>%
mutate(layerId = NAME) # unique layerId for JS
# Leaflet map
leaf_map <- leaflet() %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
# Base map tiles
addProviderTiles(providers$CartoDB.Positron) %>%
# Add all Michigan counties as background
addPolygons(
data = mi_counties,
fillColor = "lightgrey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
# Add hazard counties with unique layerId for highlighting
addPolygons(
data = counties_with_hazard,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
layerId = ~layerId,
label = ~NAME
) %>%
# Hazard site markers
addCircleMarkers(
data = hazard_sites_full,
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
)
# JavaScript for cycling hazard counties with label and highlight
js_auto_hover_hazard <- "
function(el, x) {
var map = this;
var polygons = [];
// Collect polygons that have layerId (hazard counties)
map.eachLayer(function(layer) {
if(layer instanceof L.Polygon && layer.options.layerId !== undefined) {
polygons.push(layer);
}
});
var i = 0;
setInterval(function() {
// Reset all hazard polygons to original style
polygons.forEach(function(p) {
p.setStyle({fillColor: 'grey', fillOpacity: 0.3, weight:1});
p.closeTooltip();
});
// Highlight current polygon
polygons[i].setStyle({fillColor: 'orange', fillOpacity: 0.5, weight:2});
// Show tooltip
polygons[i].bindTooltip(polygons[i].options.layerId, {permanent:true, direction:'auto'}).openTooltip();
i = (i + 1) % polygons.length;
}, 2000); // cycle every 2 seconds
}
"
# Attach JS auto-hover
leaf_map <- htmlwidgets::onRender(leaf_map, js_auto_hover_hazard)
leaf_map
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Color palette
max_radius <- 20
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max(hazard_sites_full$Hazard_Index, na.rm = TRUE))
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups for hazard sites
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Identify counties with hazard sites
counties_with_hazard <- mi_counties %>%
filter(NAME %in% unique(hazard_sites_full$system_name)) %>%
mutate(layerId = NAME)
# Build Leaflet map
leaf_map <- leaflet() %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
# Base map
addProviderTiles(providers$CartoDB.Positron) %>%
# All Michigan counties
addPolygons(
data = mi_counties,
fillColor = "lightgrey",
color = "black",
weight = 1,
fillOpacity = 0.3
) %>%
# Hazard counties with layerId
addPolygons(
data = counties_with_hazard,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
layerId = ~layerId,
label = ~NAME
) %>%
# Hazard site markers
addCircleMarkers(
data = hazard_sites_full,
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
),
layerId = ~system_name
)
# JS to cycle through hazard counties and show site popups
js_auto_hover_sites <- "
function(el, x) {
var map = this;
// Collect hazard counties
var polygons = [];
map.eachLayer(function(layer) {
if(layer instanceof L.Polygon && layer.options.layerId !== undefined) {
polygons.push(layer);
}
});
// Collect markers grouped by county
var markersByCounty = {};
map.eachLayer(function(layer) {
if(layer instanceof L.CircleMarker && layer.options.layerId !== undefined) {
if(!markersByCounty[layer.options.layerId]) {
markersByCounty[layer.options.layerId] = [];
}
markersByCounty[layer.options.layerId].push(layer);
}
});
var i = 0;
setInterval(function() {
// Reset all polygons
polygons.forEach(function(p) {
p.setStyle({fillColor:'grey', fillOpacity:0.3, weight:1});
});
// Close all marker popups
Object.values(markersByCounty).flat().forEach(function(m) {
m.closePopup();
});
// Highlight current polygon
var currentPolygon = polygons[i];
currentPolygon.setStyle({fillColor:'orange', fillOpacity:0.5, weight:2});
// Open popups for markers inside this county
var countyName = currentPolygon.options.layerId;
var markers = markersByCounty[countyName];
if(markers) {
markers.forEach(function(m) {
m.openPopup();
});
}
i = (i + 1) % polygons.length;
}, 2500); // cycle every 2.5 seconds
}
"
# Attach JS to map
leaf_map <- htmlwidgets::onRender(leaf_map, js_auto_hover_sites)
leaf_map
quarto render

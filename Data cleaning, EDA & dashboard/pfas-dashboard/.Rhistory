replace_na(list(system_name = "Unknown",
type = "Unknown")) |>
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(
Hazard_Index = as.numeric(Hazard_Index),
popup_label = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", sprintf("%.1f", Hazard_Index)
)
)
# Color palette + scaled radius
max_radius <- 20
desired_max <- 35
# Update scaled_radius calculation to use desired_max
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / desired_max) * max_radius)
# Create legend data with extended range and scaled radius
legend_data <- tibble(
Hazard_Index = seq(5, desired_max, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / desired_max) * max_radius)
hazard_pal <- colorNumeric(
palette = c("#e5f5f9", "#99d8c9", "#2ca25f", "#006d2c"),
domain = c(0, desired_max)
)
# Build searchable field
hazard_sites_full <- hazard_sites_full %>%
mutate(search_field = system_name)
# SharedData for Crosstalk
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# LEAFLET MAP
map_widget <- hazard_sites_full %>%
leaflet() %>%
setView(lng = -84.5, lat = 44.5, zoom = 5.5) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3
) %>%
addCircleMarkers(
lng = ~st_coordinates(geometry)[,1],
lat = ~st_coordinates(geometry)[,2],
radius = ~scaled_radius,
color = ~hazard_pal(Hazard_Index),
fillColor = ~hazard_pal(Hazard_Index),
fillOpacity = 0.7,
opacity = 1,
weight = 1,
popup = ~popup_label,
label = ~lapply(popup_label, htmltools::HTML)
) |>
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = 'Hazard Index',
baseSize = max_radius / sqrt(desired_max / desired_max),  # Scaling factor
shape = 'circle',
orientation = 'vertical',
opacity = 1,
fillOpacity = 0.7,
position = 'bottomright',
breaks = legend_data$Hazard_Index
)
map_widget
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26")
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(Hazard_Index = as.numeric(Hazard_Index))
# Crosstalk searchable field
hazard_sites_full <- hazard_sites_full %>%
mutate(search_field = system_name)
# Crosstalk SharedData
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# Color palette (UPDATED)
max_radius <- 20
desired_max <- max(hazard_sites_full$Hazard_Index, na.rm = TRUE)
max_val <- ceiling(desired_max / 5) * 5   # round up to nearest 5
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max_val)
)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend data for bubble legend (fixed scale of 5)
legend_data <- tibble(
Hazard_Index = seq(5, max_val, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / max_val) * max_radius)
# Get bounding box of Michigan counties
mi_bounds <- st_bbox(mi_counties)
# Crosstalk filter widget (search by system name)
filter_widget <- filter_select(
id = "system_filter",
label = "Filter by System Name",
sharedData = shared_data,
group = ~search_field
)
# Build interactive Leaflet map with bubble legend + Crosstalk
bscols(
widths = c(3, 9),
filter_widget,
leaflet(shared_data) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = "Hazard Index",
baseSize = max_radius,
shape = "circle",
orientation = "vertical",
opacity = 1,
fillOpacity = 0.7,
position = "bottomright",
breaks = legend_data$Hazard_Index
)
)
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile (FIX: transform to WGS84)
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26") %>%
st_transform(4326)
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(
Hazard_Index = as.numeric(Hazard_Index),
search_field = system_name   # Crosstalk searchable field
)
# Color palette (UPDATED)
max_radius <- 20
desired_max <- max(hazard_sites_full$Hazard_Index, na.rm = TRUE)
max_val <- ceiling(desired_max / 5) * 5   # round up to nearest 5
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max_val)
)
# Compute scaled radius BEFORE SharedData (FIX)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Crosstalk SharedData (FIX: now includes scaled_radius)
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend data for bubble legend (fixed scale of 5)
legend_data <- tibble(
Hazard_Index = seq(5, max_val, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / max_val) * max_radius)
# Get bounding box of Michigan counties
mi_bounds <- st_bbox(mi_counties)
# Crosstalk filter widget
filter_widget <- filter_select(
id = "system_filter",
label = "Filter by System Name",
sharedData = shared_data,
group = ~search_field
)
# Build interactive Leaflet map with bubble legend + Crosstalk
bscols(
widths = c(3, 9),
filter_widget,
leaflet(shared_data) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = "Hazard Index",
baseSize = max_radius,
shape = "circle",
orientation = "vertical",
opacity = 1,
fillOpacity = 0.7,
position = "bottomright",
breaks = legend_data$Hazard_Index
)
)
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile (FIX: transform to WGS84)
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26") %>%
st_transform(4326)
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(
Hazard_Index = as.numeric(Hazard_Index),
search_field = system_name   # Crosstalk searchable field
)
# Color palette (UPDATED)
max_radius <- 20
desired_max <- max(hazard_sites_full$Hazard_Index, na.rm = TRUE)
max_val <- ceiling(desired_max / 5) * 5   # round up to nearest 5
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max_val)
)
# Compute scaled radius BEFORE SharedData (FIX)
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Crosstalk SharedData (FIX: now includes scaled_radius)
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend data for bubble legend (fixed scale of 5)
legend_data <- tibble(
Hazard_Index = seq(5, max_val, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / max_val) * max_radius)
# Get bounding box of Michigan counties
mi_bounds <- st_bbox(mi_counties)
# Crosstalk filter widget
filter_widget <- filter_select(
id = "system_filter",
label = "Filter by System Name",
sharedData = shared_data,
group = ~search_field
)
# Build interactive Leaflet map with bubble legend + Crosstalk
bscols(
widths = c(3, 9),
filter_widget,
leaflet(shared_data) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = "Hazard Index",
baseSize = max_radius,
shape = "circle",
orientation = "vertical",
opacity = 1,
fillOpacity = 0.7,
position = "bottomright",
breaks = legend_data$Hazard_Index
)
)
# Define main hazard analytes
hazard_analytes <- c("HFPODA", "PFNA", "PFBS", "PFHxS")
# Load Michigan counties shapefile (FIX: transform to WGS84)
mi_counties <- st_read("GeoFiles/cb_2018_us_county_500k.shp", quiet = TRUE) %>%
filter(STATEFP == "26") %>%
st_transform(4326)
# Prepare analyte-wide data
analyte_wide <- public_water_max_long %>%
filter(analyte %in% hazard_analytes) %>%
select(hex_id, analyte, analyte_value) %>%
pivot_wider(
names_from = analyte,
values_from = analyte_value,
values_fill = 0
)
# Prepare hazard sites
hazard_sites_full <- public_water_max_long %>%
filter(Hazard_Index > 1) %>%
distinct(hex_id, system_name, system_type, Hazard_Index, longitude, latitude) %>%
rename(type = system_type) %>%
left_join(analyte_wide, by = "hex_id") %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
mutate(
Hazard_Index = as.numeric(Hazard_Index),
search_field = system_name
)
# Color palette (UPDATED)
max_radius <- 20
desired_max <- max(hazard_sites_full$Hazard_Index, na.rm = TRUE)
max_val <- ceiling(desired_max / 5) * 5
hazard_pal <- colorNumeric(
palette = "YlOrRd",
domain = c(0, max_val)
)
# Compute scaled radius BEFORE SharedData
hazard_sites_full <- hazard_sites_full %>%
mutate(scaled_radius = sqrt(Hazard_Index / max(Hazard_Index, na.rm = TRUE)) * max_radius)
# Crosstalk SharedData
shared_data <- SharedData$new(
hazard_sites_full,
key = ~hex_id,
group = "hazard"
)
# Popups
hazard_popup <- hazard_sites_full %>%
mutate(popup = paste0(
"<b>System Name:</b> ", system_name, "<br>",
"<b>Type:</b> ", type, "<br>",
"<b>Hazard Index:</b> ", round(Hazard_Index, 2), "<br>",
"<b>HFPODA:</b> ", round(HFPODA, 2), "<br>",
"<b>PFNA:</b> ", round(PFNA, 2), "<br>",
"<b>PFBS:</b> ", round(PFBS, 2), "<br>",
"<b>PFHxS:</b> ", round(PFHxS, 2)
))
# Legend data for bubble legend (fixed scale of 5)
legend_data <- tibble(
Hazard_Index = seq(5, max_val, by = 5)
) %>%
mutate(scaled_radius = sqrt(Hazard_Index / max_val) * max_radius)
# Crosstalk filter widget (top of page)
filter_widget <- filter_select(
id = "system_filter",
label = "Filter by System Name",
sharedData = shared_data,
group = ~search_field
)
# Build interactive Leaflet map with bubble legend + Crosstalk
bscols(
widths = 12,   # FULL WIDTH MAP
filter_widget,
leaflet(shared_data) %>%
setView(lng = -84.5, lat = 44.5, zoom = 6) %>%
addProviderTiles(providers$CartoDB.Positron) %>%
addPolygons(
data = mi_counties,
fillColor = "grey",
color = "black",
weight = 1,
fillOpacity = 0.3,
label = ~NAME
) %>%
addCircleMarkers(
radius = ~scaled_radius,
fillColor = ~hazard_pal(Hazard_Index),
color = "black",
fillOpacity = 0.7,
stroke = TRUE,
weight = 0.5,
label = lapply(hazard_popup$popup, HTML),
labelOptions = labelOptions(
direction = "auto",
textsize = "12px",
opacity = 0.9,
offset = c(0, -5)
)
) %>%
addLegendSize(
values = legend_data$Hazard_Index,
pal = hazard_pal,
title = "Hazard Index",
baseSize = max_radius,
shape = "circle",
orientation = "vertical",
opacity = 1,
fillOpacity = 0.7,
position = "bottomright",
breaks = legend_data$Hazard_Index
)
)
